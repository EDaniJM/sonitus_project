{% extends "base.html" %}
{% load static %}

{% block title %}New Support{% endblock %}

{% block content %}

<h1 class="h3 mb-3">Add a new support</h1>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Fill in the support ticket details</h5>
            </div>
            <div class="card-body">
                <form method="POST">
                    {% csrf_token %}

                    {% if support_form.non_field_errors %}
                    <div class="alert alert-danger">
                        {{ support_form.non_field_errors }}
                    </div>
                    {% endif %}


                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ support_form.client.id_for_label }}" class="form-label">
                                Client
                                <a href="#" class="btn btn-sm btn-outline-primary ms-2" data-bs-toggle="modal"
                                    data-bs-target="#addClientModal">+</a>
                            </label>
                            {{ support_form.client }}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ support_form.support_channel.id_for_label }}" class="form-label">
                                Support channel <span class="text-danger">*</span>
                            </label>
                            {{ support_form.support_channel }}
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="{{ support_form.problem_description.id_for_label }}" class="form-label">
                            Problem description <span class="text-danger">*</span>
                        </label>
                        {{ support_form.problem_description }}
                    </div>
                    <div class="mb-3">
                        <label for="{{ support_form.solution_description.id_for_label }}" class="form-label">
                            Solution description <span class="text-danger">*</span>
                        </label>
                        {{ support_form.solution_description }}
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3" id="kerberus-field-wrapper">
                            <label for="{{ support_form.kerberus_id.id_for_label }}" class="form-label">Kerberus ID
                            </label>
                            {{ support_form.kerberus_id }}
                        </div>

                        <div class="col-md-6 mb-3" id="freshdesk-field-wrapper">
                            <label for="{{ support_form.freshdesk_ticket.id_for_label }}" class="form-label">FreshDesk
                                Ticket</label>
                            {{ support_form.freshdesk_ticket }}
                        </div>

                        <div class="col-md-6 mb-3" id="call-status-wrapper">
                            <label for="{{ support_form.call_status.id_for_label }}" class="form-label">Call
                                Status</label>
                            {{ support_form.call_status }}
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3" id="waiting-time-wrapper">
                            <label for="{{ support_form.waiting_time.id_for_label }}" class="form-label">Waiting
                                time</label>
                            {{ support_form.waiting_time }}
                            {% if support_form.waiting_time.errors %}
                            <div class="invalid-feedback d-block">
                                {{ support_form.waiting_time.errors|striptags }}
                            </div>
                            {% endif %}
                        </div>

                        <div class="col-md-6 mb-3" id="duration-wrapper">
                            <label for="{{ support_form.duration.id_for_label }}" class="form-label">Duration</label>
                            {{ support_form.duration }}
                            {% if support_form.duration.errors %}
                            <div class="invalid-feedback d-block">
                                {{ support_form.duration.errors|striptags }}
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <hr>
                    <div class="d-flex justify-content-end">
                        <a href="{% url 'core:dashboard' %}" class="btn btn-secondary me-2">Cancel</a>
                        <button type="submit" name="submit_support_form" class="btn btn-primary">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% block modals %}
<div class="modal fade" id="addClientModal" tabindex="-1" aria-labelledby="addClientModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addClientModalLabel">Add a new client</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div id="client-form-content">
                <form method="POST">
                    {% csrf_token %}
                    <div class="modal-body">
                        {% if client_form.non_field_errors %}
                        <div class="alert alert-danger">{{ client_form.non_field_errors }}</div>
                        {% endif %}

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ client_form.name.id_for_label }}" class="form-label">Name</label>
                                {{ client_form.name }}
                                {% if client_form.name.errors %}<div class="text-danger small mt-1">{{
                                    client_form.name.errors|first }}</div>{% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ client_form.lastname.id_for_label }}" class="form-label">Last
                                    Name</label>
                                {{ client_form.lastname }}
                                {% if client_form.lastname.errors %}<div class="text-danger small mt-1">{{
                                    client_form.lastname.errors|first }}</div>{% endif %}
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="{{ client_form.company.id_for_label }}" class="form-label">
                                Company <a href="#" class="btn btn-sm btn-outline-primary ms-2"
                                    id="open-company-modal-btn">+</a>
                            </label>
                            {{ client_form.company }}
                            {% if client_form.company.errors %}<div class="text-danger small mt-1">{{
                                client_form.company.errors|first }}</div>{% endif %}
                        </div>

                        <div class="mb-3">
                            <label for="{{ client_form.client_type.id_for_label }}" class="form-label">Client
                                type</label>
                            {{ client_form.client_type }}
                        </div>
                        <div class="mb-3">
                            <label for="{{ client_form.country.id_for_label }}" class="form-label">Country</label>
                            {{ client_form.country }}
                        </div>
                        <div class="mb-3">
                            <label for="{{ client_form.email.id_for_label }}" class="form-label">Email</label>
                            {{ client_form.email }}
                            {% if client_form.email.errors %}<div class="text-danger small mt-1">{{
                                client_form.email.errors|first }}</div>{% endif %}
                        </div>
                        <div class="mb-3">
                            <label for="{{ client_form.phone.id_for_label }}" class="form-label">Phone</label>
                            <div class="input-group">
                                <span class="input-group-text" id="phone-code-prefix">+</span>
                                {{ client_form.phone }}
                            </div>
                            {% if client_form.phone.errors %}<div class="text-danger small mt-1">{{
                                client_form.phone.errors|first }}</div>{% endif %}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" name="submit_client_form" class="btn btn-primary">Save</button>
                    </div>
                </form>
            </div>

            <div id="company-form-content" class="d-none">
                <form method="POST">
                    {% csrf_token %}
                    <div class="modal-body">
                        <label for="{{ company_form.name.id_for_label }}" class="form-label">Company Name</label>
                        {{ company_form.name }}
                        {% if company_form.errors %}<div class="text-danger small mt-1">{{ company_form.errors|first }}
                        </div>{% endif %}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" id="back-to-client-btn">← Back</button>
                        <button type="submit" name="submit_company_form" class="btn btn-primary">Save Company</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% block scripts %}
<script>
    $(document).ready(function () {
        // --- LÓGICA DE SELECT2 PARA EL CAMPO CLIENTE ---
        $('#{{ support_form.client.auto_id }}').select2({
            placeholder: "Search by client name...",
            minimumInputLength: 1,
            ajax: {
                url: "{% url 'core:client_search' %}",
                dataType: 'json',
                delay: 250,
                processResults: function (data) {
                    return {
                        results: data.results
                    };
                },
                cache: true
            },
            templateResult: formatClientResult,
            templateSelection: function (client) {
                return client.full_label || client.text || client.id;
            },
            escapeMarkup: function (m) { return m; }
        });

        $('#company-form-content form').on('submit', function (e) {
            e.preventDefault(); // Evitamos que la página se recargue

            $.ajax({
                type: 'POST',
                url: $(this).attr('action'), // La URL del formulario
                data: $(this).serialize() + '&submit_company_form=1', // Añadimos el nombre del botón
                headers: { 'X-Requested-With': 'XMLHttpRequest' },
                success: function (response) {
                    // 1. Creamos una nueva opción para el selector de empresa
                    var newOption = new Option(response.name, response.id, true, true);
                    // 2. La añadimos al selector y lo actualizamos
                    $('#{{ client_form.company.auto_id }}').append(newOption).trigger('change');

                    // 3. Volvemos a la vista del cliente
                    showClientView();
                },
                error: function (response) {
                    // Manejo de errores (puedes hacerlo más robusto si quieres)
                    alert('Error al guardar la empresa.');
                }
            });
        });

        function formatClientResult(client) {
            if (!client.id) {
                return client.text;
            }

            // Creamos un bloque de HTML para cada resultado
            var $container = $(
                '<div class="select2-result-repository clearfix">' +
                '<div class="select2-result-repository__title"></div>' +
                '<div class="select2-result-repository__description"></div>' +
                '</div>'
            );

            // Llenamos el HTML con los datos del cliente
            $container.find(".select2-result-repository__title").text(client.full_label || client.text);
            $container.find(".select2-result-repository__description").text(
                (client.client_type || 'N/A') + ' | ' + (client.email || 'N/A') + ' | ' +
                (client.phone || 'N/A') + ' | ' + (client.country || 'N/A')
            );

            return $container;
        }
        const countryCodes = JSON.parse('{{ country_codes_json|safe }}');
        const countrySelect = document.querySelector('#addClientModal select[name="country"]');
        const phonePrefixSpan = document.querySelector('#addClientModal #phone-code-prefix');
        const phoneInput = document.querySelector('#addClientModal input[name="phone"]');
        const clientForm = document.querySelector('#addClientModal form');

        if (countrySelect && phonePrefixSpan && phoneInput && clientForm) {
            function updatePhonePrefix() {
                const selectedId = countrySelect.value;
                const rawCode = countryCodes[selectedId] || '+';
                const firstCode = rawCode.split(',')[0].trim();
                phonePrefixSpan.textContent = firstCode || '+';
            }

            // Actualiza al cargar y al cambiar el país
            updatePhonePrefix();
            countrySelect.addEventListener('change', updatePhonePrefix);

            // Añadir código al número antes de enviar
            clientForm.addEventListener('submit', function () {
                let prefix = phonePrefixSpan.textContent.trim();
                let phone = phoneInput.value.trim();

                // Eliminar 0 inicial si existe
                if (phone.startsWith('0')) {
                    phone = phone.slice(1);
                }

                // Añadir el prefijo si no lo tiene
                if (!phone.startsWith(prefix)) {
                    phoneInput.value = prefix + phone;
                }
            });
        }
        // Activa el selector de tiempo
        flatpickr(".duration-picker", {
            enableTime: true,
            noCalendar: true,
            dateFormat: "H:i:S",
            enableSeconds: true,
            time_24hr: true,
            defaultDate: "00:00:00"
        });

        // 1. Obtenemos los datos que la vista nos envió
        const channelCallData = JSON.parse('{{ channel_call_data_json|safe }}');

        // 2. Obtenemos los elementos del DOM
        const supportChannelSelect = document.getElementById('{{ support_form.support_channel.auto_id }}');
        const kerberusField = document.getElementById('kerberus-field-wrapper');
        const freshdeskField = document.getElementById('freshdesk-field-wrapper');
        const callStatusField = document.getElementById('call-status-wrapper');
        const waitingTimeField = document.getElementById('waiting-time-wrapper');
        const durationField = document.getElementById('duration-wrapper');

        function toggleAllConditionalFields() {
            const selectedChannelId = supportChannelSelect.value;
            const selectedChannelText = supportChannelSelect.options[supportChannelSelect.selectedIndex].text;
            const isCall = channelCallData[selectedChannelId] || false;

            kerberusField.classList.add('d-none');
            freshdeskField.classList.add('d-none');
            callStatusField.classList.add('d-none');
            waitingTimeField.classList.add('d-none');
            durationField.classList.add('d-none');

            if (selectedChannelText.includes('Training Presential')) {
                durationField.classList.remove('d-none'); // Solo muestra Duración
            }
            else if (isCall) {
                // Si es una llamada, muestra los campos de llamada
                callStatusField.classList.remove('d-none');
                waitingTimeField.classList.remove('d-none');
                durationField.classList.remove('d-none');

                // Lógica específica para el ID
                if (selectedChannelText.includes('Kerberus') || selectedChannelText.includes('Call Center')) {
                    kerberusField.classList.remove('d-none');
                }
            }
            else { // Lógica para otros canales que no son llamada
                if (selectedChannelText.includes('FreshDesk')) {
                    freshdeskField.classList.remove('d-none');
                }
            }
        }

        // Ejecutamos la función al cargar y al cambiar
        toggleAllConditionalFields();
        supportChannelSelect.addEventListener('change', toggleAllConditionalFields);

        // --- LÓGICA PARA INTERCAMBIAR VISTAS EN EL MODAL ---
        const modalTitle = document.getElementById('addClientModalLabel');
        const clientFormContent = document.getElementById('client-form-content');
        const companyFormContent = document.getElementById('company-form-content');
        const openCompanyBtn = document.getElementById('open-company-modal-btn');
        const backToClientBtn = document.getElementById('back-to-client-btn');

        // Función para mostrar la vista de "Añadir Empresa"
        function showCompanyView() {
            modalTitle.textContent = 'Add a new company';
            clientFormContent.classList.add('d-none');
            companyFormContent.classList.remove('d-none');
        }

        // Función para mostrar la vista de "Añadir Cliente"
        function showClientView() {
            modalTitle.textContent = 'Add a new client';
            companyFormContent.classList.add('d-none');
            clientFormContent.classList.remove('d-none');
        }

        // Event Listeners para los botones
        openCompanyBtn.addEventListener('click', function (e) {
            e.preventDefault();
            showCompanyView();
        });

        backToClientBtn.addEventListener('click', function (e) {
            e.preventDefault();
            showClientView();
        });


        // --- LÓGICA PARA REABRIR EL MODAL CON ERRORES ---
        {% if client_form_invalid %}
        setTimeout(function () {
            const clientModal = new bootstrap.Modal(document.getElementById('addClientModal'));
            clientModal.show();
            showClientView(); // Aseguramos que se vea la vista correcta
        }, 50);
        {% endif %}

        {% if company_form_invalid %}
        setTimeout(function () {
            const clientModalInstance = bootstrap.Modal.getInstance(document.getElementById('addClientModal'));
            if (clientModalInstance) {
                clientModalInstance.hide();
            }
            const companyModal = new bootstrap.Modal(document.getElementById('addCompanyModal'));
            companyModal.show();
        }, 100);
        {% endif %}
    });



</script>
{% endblock %}